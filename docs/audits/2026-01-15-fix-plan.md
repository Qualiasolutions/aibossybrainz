# Production Audit Fix Plan

**Created:** 2026-01-15
**Based on:** Production Readiness Audit (Score: 62/100)
**Target Score:** 85/100+

---

## Phase 1: Blockers (Must Complete Before Deploy)

### 1.1 Database Schema Gaps

#### Task 1.1.1: Create Missing Table Migrations
**Priority:** BLOCKER
**Files to create:**
- `supabase/migrations/20260115_add_strategy_canvas.sql`
- `supabase/migrations/20260115_add_conversation_summary.sql`
- `supabase/migrations/20260115_add_audit_log.sql`

**Implementation:**
```sql
-- 20260115_add_strategy_canvas.sql
CREATE TABLE IF NOT EXISTS "StrategyCanvas" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "chatId" UUID NOT NULL REFERENCES "Chat"("id") ON DELETE CASCADE,
    "userId" TEXT NOT NULL,
    "canvasType" TEXT NOT NULL CHECK ("canvasType" IN ('swot', 'bmc', 'journey', 'brainstorm')),
    "title" TEXT NOT NULL,
    "data" JSONB NOT NULL DEFAULT '{}',
    "createdAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "updatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "deletedAt" TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_strategy_canvas_user ON "StrategyCanvas"("userId", "deletedAt");
CREATE INDEX idx_strategy_canvas_chat ON "StrategyCanvas"("chatId", "deletedAt");
```

```sql
-- 20260115_add_conversation_summary.sql
CREATE TABLE IF NOT EXISTS "ConversationSummary" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "chatId" UUID NOT NULL REFERENCES "Chat"("id") ON DELETE CASCADE,
    "userId" TEXT NOT NULL,
    "summary" TEXT NOT NULL,
    "topics" TEXT[] DEFAULT '{}',
    "sentiment" TEXT,
    "keyInsights" JSONB DEFAULT '[]',
    "createdAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "updatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "expiresAt" TIMESTAMP WITH TIME ZONE,
    "deletedAt" TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_conversation_summary_user ON "ConversationSummary"("userId", "deletedAt");
CREATE INDEX idx_conversation_summary_chat ON "ConversationSummary"("chatId");
```

```sql
-- 20260115_add_audit_log.sql
CREATE TABLE IF NOT EXISTS "AuditLog" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "userId" TEXT NOT NULL,
    "action" TEXT NOT NULL,
    "resource" TEXT NOT NULL,
    "resourceId" TEXT,
    "details" JSONB DEFAULT '{}',
    "ipAddress" TEXT,
    "userAgent" TEXT,
    "createdAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_audit_log_user ON "AuditLog"("userId", "createdAt");
CREATE INDEX idx_audit_log_resource ON "AuditLog"("resource", "resourceId");
CREATE INDEX idx_audit_log_action ON "AuditLog"("action", "createdAt");
```

---

#### Task 1.1.2: Add RLS Policies for New Tables
**Priority:** BLOCKER
**File to create:** `supabase/migrations/20260115_add_missing_rls.sql`

**Implementation:**
```sql
-- Enable RLS
ALTER TABLE "StrategyCanvas" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "ConversationSummary" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "AuditLog" ENABLE ROW LEVEL SECURITY;

-- StrategyCanvas policies
CREATE POLICY "strategycanvas_select_own" ON "StrategyCanvas"
FOR SELECT TO authenticated
USING (auth.uid()::text = "userId" AND "deletedAt" IS NULL);

CREATE POLICY "strategycanvas_insert_own" ON "StrategyCanvas"
FOR INSERT TO authenticated
WITH CHECK (auth.uid()::text = "userId");

CREATE POLICY "strategycanvas_update_own" ON "StrategyCanvas"
FOR UPDATE TO authenticated
USING (auth.uid()::text = "userId" AND "deletedAt" IS NULL);

CREATE POLICY "strategycanvas_delete_own" ON "StrategyCanvas"
FOR DELETE TO authenticated
USING (auth.uid()::text = "userId");

-- ConversationSummary policies
CREATE POLICY "conversationsummary_select_own" ON "ConversationSummary"
FOR SELECT TO authenticated
USING (auth.uid()::text = "userId" AND "deletedAt" IS NULL);

CREATE POLICY "conversationsummary_insert_own" ON "ConversationSummary"
FOR INSERT TO authenticated
WITH CHECK (auth.uid()::text = "userId");

CREATE POLICY "conversationsummary_update_own" ON "ConversationSummary"
FOR UPDATE TO authenticated
USING (auth.uid()::text = "userId" AND "deletedAt" IS NULL);

-- AuditLog policies (read-only for users, service role for writes)
CREATE POLICY "auditlog_select_own" ON "AuditLog"
FOR SELECT TO authenticated
USING (auth.uid()::text = "userId");

-- Service role can insert (no user policy needed)
```

---

### 1.2 GDPR Compliance

#### Task 1.2.1: Implement Data Export API
**Priority:** BLOCKER
**File to create:** `app/(chat)/api/export-user-data/route.ts`

**Implementation:**
```typescript
import { createClient } from "@/lib/supabase/server";
import { getUser } from "@/lib/db/queries";
import { NextResponse } from "next/server";

export const maxDuration = 60;

export async function GET() {
  const supabase = await createClient();
  const user = await getUser();

  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  // Collect all user data
  const [
    { data: profile },
    { data: chats },
    { data: messages },
    { data: documents },
    { data: reactions },
    { data: analytics },
    { data: canvases },
    { data: summaries },
  ] = await Promise.all([
    supabase.from("User").select("*").eq("id", user.id).single(),
    supabase.from("Chat").select("*").eq("userId", user.id),
    supabase.from("Message_v2").select("*").eq("chatId", chats?.map(c => c.id) || []),
    supabase.from("Document").select("*").eq("userId", user.id),
    supabase.from("MessageReaction").select("*").eq("userId", user.id),
    supabase.from("UserAnalytics").select("*").eq("userId", user.id),
    supabase.from("StrategyCanvas").select("*").eq("userId", user.id),
    supabase.from("ConversationSummary").select("*").eq("userId", user.id),
  ]);

  const exportData = {
    exportDate: new Date().toISOString(),
    user: profile,
    chats,
    messages,
    documents,
    reactions,
    analytics,
    strategyCanvases: canvases,
    conversationSummaries: summaries,
  };

  // Log the export for audit
  await logAudit({
    userId: user.id,
    action: "DATA_EXPORT",
    resource: "user_data",
    resourceId: user.id,
  });

  return NextResponse.json(exportData, {
    headers: {
      "Content-Disposition": `attachment; filename="user-data-${user.id}-${Date.now()}.json"`,
    },
  });
}
```

---

#### Task 1.2.2: Implement Audit Logging
**Priority:** BLOCKER
**File to create:** `lib/audit/logger.ts`

**Implementation:**
```typescript
import { createServiceClient } from "@/lib/supabase/server";

interface AuditLogInput {
  userId: string;
  action: string;
  resource: string;
  resourceId?: string;
  details?: Record<string, unknown>;
  ipAddress?: string;
  userAgent?: string;
}

export async function logAudit(input: AuditLogInput): Promise<void> {
  try {
    const supabase = createServiceClient();
    await supabase.from("AuditLog").insert({
      userId: input.userId,
      action: input.action,
      resource: input.resource,
      resourceId: input.resourceId,
      details: input.details || {},
      ipAddress: input.ipAddress,
      userAgent: input.userAgent,
    });
  } catch (error) {
    // Don't fail the request if audit logging fails
    console.error("Audit logging failed:", error);
  }
}

// Action constants
export const AuditActions = {
  CHAT_DELETE: "CHAT_DELETE",
  CHAT_DELETE_ALL: "CHAT_DELETE_ALL",
  DOCUMENT_DELETE: "DOCUMENT_DELETE",
  MESSAGE_DELETE: "MESSAGE_DELETE",
  DATA_EXPORT: "DATA_EXPORT",
  ACCOUNT_DELETE: "ACCOUNT_DELETE",
  PROFILE_UPDATE: "PROFILE_UPDATE",
  TOS_ACCEPT: "TOS_ACCEPT",
} as const;
```

**Files to update:**
- `lib/db/queries.ts` - Add audit logging to delete functions
- `app/(chat)/api/chat/route.ts` - Log deletions
- `app/(chat)/api/profile/route.ts` - Log profile updates

---

### 1.3 Observability

#### Task 1.3.1: Add Request ID Middleware
**Priority:** BLOCKER
**File to update:** `middleware.ts`

**Implementation:**
```typescript
import { v4 as uuid } from "uuid";
import * as Sentry from "@sentry/nextjs";

// Add to middleware function:
export async function middleware(request: NextRequest) {
  // Generate or extract request ID
  const requestId = request.headers.get("x-vercel-id") || uuid();

  // Add to Sentry context
  Sentry.setTag("request_id", requestId);

  // Continue with existing middleware logic...
  const response = await updateSession(request);

  // Add request ID to response headers
  response.headers.set("x-request-id", requestId);

  return response;
}
```

---

### 1.4 Documentation

#### Task 1.4.1: Document Backup Strategy
**Priority:** BLOCKER
**File to update:** `supabase/README.md`

**Add section:**
```markdown
## Backup & Recovery

### Supabase Backup Configuration
- **Tier:** Pro (verify in Supabase Dashboard)
- **Daily Backups:** Enabled (automatic)
- **Retention:** 7 days
- **Point-in-Time Recovery:** Enabled (7 day window)

### Recovery Procedures

#### Restore from Daily Backup
1. Go to Supabase Dashboard > Settings > Backups
2. Select the backup date to restore
3. Click "Restore" and confirm
4. Wait for restore to complete (can take 5-30 minutes)
5. Verify data integrity with health check

#### Point-in-Time Recovery
1. Go to Supabase Dashboard > Settings > Backups > PITR
2. Select exact timestamp to recover to
3. Follow restore wizard
4. Verify with `/api/health` endpoint

### Backup Verification Checklist
- [ ] Verify backup tier in Supabase dashboard
- [ ] Confirm PITR is enabled
- [ ] Test restore procedure on staging (quarterly)
- [ ] Document recovery time (RTO target: 1 hour)
```

---

## Phase 2: High Priority (First Week)

### 2.1 Security Fixes

#### Task 2.1.1: Remove API Key Logging
**Priority:** HIGH
**File:** `app/(chat)/api/chat/route.ts:463`

**Change:**
```typescript
// Before
openRouterKeyPrefix: process.env.OPENROUTER_API_KEY?.slice(0, 12) + "...",

// After
hasOpenRouterKey: !!process.env.OPENROUTER_API_KEY,
```

---

#### Task 2.1.2: Fix CSRF Fallback
**Priority:** HIGH
**File:** `lib/security/csrf.ts:7`

**Change:**
```typescript
// Before
const CSRF_SECRET = process.env.AUTH_SECRET ?? "fallback-secret";

// After
const CSRF_SECRET = process.env.AUTH_SECRET;
if (!CSRF_SECRET && process.env.NODE_ENV === "production") {
  throw new Error("AUTH_SECRET environment variable is required in production");
}
```

---

### 2.2 Performance Fixes

#### Task 2.2.1: Lazy Load Heavy Dependencies
**Priority:** HIGH
**Files:** Various components using exceljs, jspdf, html2canvas

**Implementation pattern:**
```typescript
// Instead of:
import ExcelJS from "exceljs";

// Use:
const exportToExcel = async (data) => {
  const ExcelJS = (await import("exceljs")).default;
  // ... use ExcelJS
};
```

**Files to update:**
- `lib/conversation-export.ts` (exceljs, jspdf)
- Components using html2canvas
- Components using mammoth, pdf-parse

---

#### Task 2.2.2: Fix N+1 Queries in Analytics
**Priority:** HIGH
**File:** `lib/analytics/queries.ts`

**Option A - Postgres Function:**
```sql
CREATE OR REPLACE FUNCTION get_user_analytics(
  p_user_id TEXT,
  p_start_date TIMESTAMP,
  p_end_date TIMESTAMP
) RETURNS TABLE (
  total_chats BIGINT,
  total_messages BIGINT,
  tokens_used BIGINT
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(DISTINCT c.id) as total_chats,
    COUNT(m.id) as total_messages,
    COALESCE(SUM((m.parts->0->>'tokenCount')::int), 0) as tokens_used
  FROM "Chat" c
  LEFT JOIN "Message_v2" m ON m."chatId" = c.id
  WHERE c."userId" = p_user_id
    AND c."createdAt" BETWEEN p_start_date AND p_end_date
    AND c."deletedAt" IS NULL;
END;
$$ LANGUAGE plpgsql;
```

**Option B - Single Query with Joins:**
```typescript
const { data } = await supabase
  .from("Chat")
  .select(`
    id,
    messages:Message_v2(count)
  `)
  .eq("userId", userId)
  .is("deletedAt", null);
```

---

### 2.3 Reliability Fixes

#### Task 2.3.1: Add Error Handling to Vote Route
**Priority:** HIGH
**File:** `app/(chat)/api/vote/route.ts`

**Wrap PATCH handler in try/catch:**
```typescript
export async function PATCH(request: Request) {
  try {
    // existing code...
  } catch (error) {
    console.error("Vote PATCH error:", error);
    return ChatSDKError.from(error).toResponse();
  }
}
```

---

#### Task 2.3.2: Standardize Reactions Route
**Priority:** HIGH
**File:** `app/(chat)/api/reactions/route.ts`

**Replace all plain Response() with ChatSDKError:**
```typescript
// Before
return new Response("Unauthorized", { status: 401 });

// After
return new ChatSDKError("bad_request:unauthorized", "Unauthorized", 401).toResponse();
```

---

### 2.4 Deployment Fixes

#### Task 2.4.1: Create CI/CD Pipeline
**Priority:** HIGH
**File to create:** `.github/workflows/ci.yml`

```yaml
name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type Check
        run: pnpm exec tsc --noEmit

      - name: Build
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  test:
    runs-on: ubuntu-latest
    needs: lint-and-build
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - run: pnpm install --frozen-lockfile

      - name: Install Playwright
        run: pnpm exec playwright install --with-deps

      - name: Run Tests
        run: pnpm test
        env:
          PLAYWRIGHT: "True"
```

---

#### Task 2.4.2: Create Rollback Documentation
**Priority:** HIGH
**File to create:** `ROLLBACK.md`

```markdown
# Rollback Procedures

## Vercel Deployment Rollback

### Via Dashboard
1. Go to https://vercel.com/[team]/[project]/deployments
2. Find the last known good deployment
3. Click "..." menu > "Promote to Production"
4. Confirm the rollback

### Via CLI
```bash
# List recent deployments
vercel ls

# Rollback to specific deployment
vercel rollback [deployment-url]
```

## Database Rollback

### Migration Rollback
If a migration causes issues:

1. **Assess impact** - Is data affected or just schema?
2. **For schema-only changes:**
   ```sql
   -- Example: Remove a column
   ALTER TABLE "TableName" DROP COLUMN "columnName";
   ```
3. **For data migrations:**
   - Restore from PITR to before migration
   - Or run compensating queries

### Full Database Restore
1. Go to Supabase Dashboard > Settings > Backups
2. Select restore point
3. Confirm and wait for completion
4. Update environment if connection string changed

## Health Verification

After any rollback:
```bash
curl https://[production-url]/api/health
```

Expected response:
```json
{
  "status": "healthy",
  "database": "connected",
  ...
}
```
```

---

#### Task 2.4.3: Add Favicon
**Priority:** HIGH
**File to create:** `app/icon.png` (512x512 PNG)

Or use SVG:
**File to create:** `app/icon.svg`

---

### 2.5 Data Fixes

#### Task 2.5.1: Create Data Retention Policy
**Priority:** HIGH
**File to create:** `docs/DATA_RETENTION.md`

```markdown
# Data Retention Policy

## Retention Periods

| Data Type | Active | Soft-Deleted | Hard Delete |
|-----------|--------|--------------|-------------|
| User Account | Indefinite | 30 days | After 30 days |
| Chats | Indefinite | 30 days | After 30 days |
| Messages | Indefinite | 30 days | After 30 days |
| Documents | Indefinite | 30 days | After 30 days |
| Analytics | 2 years | N/A | After 2 years |
| Audit Logs | 7 years | N/A | After 7 years |
| Session Data | 24 hours | N/A | Automatic |

## Cleanup Jobs

### Daily Cleanup (Recommended)
```sql
-- Hard delete soft-deleted records older than 30 days
DELETE FROM "Chat" WHERE "deletedAt" < NOW() - INTERVAL '30 days';
DELETE FROM "Message_v2" WHERE "deletedAt" < NOW() - INTERVAL '30 days';
DELETE FROM "Document" WHERE "deletedAt" < NOW() - INTERVAL '30 days';

-- Delete expired conversation summaries
DELETE FROM "ConversationSummary" WHERE "expiresAt" < NOW();
```

### Monthly Cleanup
```sql
-- Archive old analytics (if needed)
-- Delete analytics older than 2 years
DELETE FROM "UserAnalytics" WHERE "date" < NOW() - INTERVAL '2 years';
```

## GDPR Compliance

- Users can request data export via `/api/export-user-data`
- Users can request deletion via `/api/delete-account`
- 30-day grace period before hard deletion
- Audit trail preserved for 7 years
```

---

#### Task 2.5.2: Implement Account Deletion
**Priority:** HIGH
**File to create:** `app/(chat)/api/delete-account/route.ts`

```typescript
import { createClient } from "@/lib/supabase/server";
import { getUser } from "@/lib/db/queries";
import { logAudit, AuditActions } from "@/lib/audit/logger";
import { NextResponse } from "next/server";

export async function POST(request: Request) {
  const supabase = await createClient();
  const user = await getUser();

  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const { confirmation } = await request.json();

  if (confirmation !== "DELETE MY ACCOUNT") {
    return NextResponse.json(
      { error: "Please type 'DELETE MY ACCOUNT' to confirm" },
      { status: 400 }
    );
  }

  // Soft delete all user data
  const now = new Date().toISOString();

  await Promise.all([
    supabase.from("Chat").update({ deletedAt: now }).eq("userId", user.id),
    supabase.from("Document").update({ deletedAt: now }).eq("userId", user.id),
    supabase.from("StrategyCanvas").update({ deletedAt: now }).eq("userId", user.id),
    supabase.from("ConversationSummary").update({ deletedAt: now }).eq("userId", user.id),
  ]);

  // Log the deletion request
  await logAudit({
    userId: user.id,
    action: AuditActions.ACCOUNT_DELETE,
    resource: "user",
    resourceId: user.id,
    details: { scheduledHardDelete: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) },
  });

  // Mark user for deletion (add deletedAt to User table first)
  await supabase.from("User").update({ deletedAt: now }).eq("id", user.id);

  // Sign out the user
  await supabase.auth.signOut();

  return NextResponse.json({
    message: "Account scheduled for deletion. You have 30 days to cancel by logging back in.",
  });
}
```

---

## Phase 3: Medium Priority (This Month)

### 3.1 Performance
- [ ] Convert marketing page `<img>` to `next/image`
- [ ] Add Audio event listener cleanup in `use-auto-speak.ts`
- [ ] Add `prefetch={false}` to sidebar history items
- [ ] Refactor marketing page to server component

### 3.2 Security
- [ ] Add DOMPurify for innerHTML usage in diffview.tsx
- [ ] Monitor @vercel/blob updates for undici fix

### 3.3 Observability
- [ ] Add structured logging with context
- [ ] Add custom Sentry breadcrumbs for key actions
- [ ] Configure Sentry alerts in dashboard
- [ ] Set up uptime monitoring (UptimeRobot/BetterStack)

### 3.4 Deployment
- [ ] Align domain URLs (vercel.app vs custom)
- [ ] Add www redirect if using custom domain
- [ ] Add OpenGraph/Twitter meta tags
- [ ] Document zero-downtime requirements

### 3.5 Data
- [ ] Add soft delete to User table
- [ ] Create seed data for staging
- [ ] Document migration rollback procedures
- [ ] Create data cleanup cron job

---

## Implementation Order

### Day 1-2: Blockers
1. Create missing table migrations
2. Add RLS policies
3. Apply migrations to Supabase
4. Implement audit logger
5. Add request ID middleware
6. Document backup strategy

### Day 3-4: High Priority Security & Performance
7. Remove API key logging
8. Fix CSRF fallback
9. Lazy load heavy dependencies
10. Fix N+1 queries

### Day 5-6: High Priority Reliability & Deployment
11. Add error handling to routes
12. Create CI/CD pipeline
13. Create rollback documentation
14. Add favicon

### Day 7: High Priority Data
15. Create data retention policy
16. Implement GDPR data export
17. Implement account deletion

### Week 2+: Medium Priority
18. Performance optimizations
19. Observability improvements
20. Documentation updates

---

## Verification Checklist

After completing Phase 1:
- [ ] All migrations applied successfully
- [ ] RLS policies verified with test queries
- [ ] Data export API tested
- [ ] Audit logs being written
- [ ] Request IDs in response headers
- [ ] Backup documentation reviewed

After completing Phase 2:
- [ ] No API keys in error logs
- [ ] CSRF throws in production without AUTH_SECRET
- [ ] Bundle size reduced (check with `pnpm build`)
- [ ] N+1 queries eliminated (check Supabase logs)
- [ ] CI pipeline passing
- [ ] Rollback tested on staging

---

**Plan Complete. Ready for implementation.**
